{% extends "base.html" %}
{% load static %}
{% block css %} 
<link rel="stylesheet" href="{% static 'post_detail.css' %}">
{% endblock %}
{% block content %}
<div class="post-container">
    <h2 class="post-header">Post by {{ post.user.username }}</h2>
    <p class="post-meta"><strong>Posted on:</strong> {{ post.created_at }}</p>

    <p>
        {% for word in post.caption.split %}
            {% if word|first == "#" %}
                <a href="{% url 'hashtag_posts' word|slice:'1:' %}">{{ word }}</a>
            {% elif word|first == "@" %}
                <a href="{% url 'search_profile_page' word|slice:'1:' %}">{{ word }}</a>
            {% else %}
                {{ word }}
            {% endif %}
        {% endfor %}
    </p>

    <div class="media-container">
        {% for media in post.media.all %}
            {% if media.is_image %}
                <img src="{{ media.file.url }}" alt="Post Image">
            {% elif media.is_video %}
                <video controls>
                    <source src="{{ media.file.url }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            {% endif %}
        {% empty %}
            <p><em>No media uploaded.</em></p>
        {% endfor %}
    </div>


    <!-- Real-Time Like Button -->
    <p><strong>Likes:</strong> <span id="like-count">{{ post.likes.count }}</span></p>

    <button type="button" id="like-btn" data-liked="{{ is_liked|yesno:"true,false" }}" data-post-id="{{ post.id }}">
        {% if is_liked %}‚ù§Ô∏è Unlike{% else %}ü§ç Like{% endif %}
    </button>
    

    <!-- Real-Time Comment Input -->
    <div class="comment-form">
        <textarea id="comment-input" placeholder="Add a comment..."></textarea>
        <button id="send-comment" data-post-id="{{ post.id }}">Send</button>
    </div>

    <!-- Comments and Replies Display -->
    <div id="comments-section">
        {% for comment in post.comments.all %}
            {% if not comment.parent %}
                <div class="comment" data-comment-id="{{ comment.id }}">
                    <p><strong>{{ comment.user.username }}</strong>: {{ comment.text }}</p>
                    <button class="reply-btn" data-parent-id="{{ comment.id }}">Reply</button>
                    <div class="replies">
                        {% for reply in comment.replies.all %}
                            <div class="reply" data-reply-id="{{ reply.id }}">
                                <p><strong>{{ reply.user.username }}</strong>: {{ reply.text }}</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- Hidden Reply Input Template -->
    <div id="reply-form-template" style="display: none;">
        <textarea class="reply-input" placeholder="Write a reply..."></textarea>
        <button class="send-reply">Send</button>
    </div>

    <!-- Post Actions -->
    <div class="actions">
        <a href="{% url 'home_page' %}">‚Üê Back to Home</a>
        {% if request.user == post.user %}
            | <a href="{% url 'edit_post' post.id %}">Edit</a>
            | <a href="{% url 'delete_post' post.id %}" style="color: red;">Delete</a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block WebSocketJS%}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const username = "{{ request.user.username }}";
        const postId = "{{ post.id }}";
        const likeBtn = document.getElementById("like-btn");
        const likeCount = document.getElementById("like-count");
        const commentInput = document.getElementById("comment-input");
        const sendCommentBtn = document.getElementById("send-comment");
        const commentsSection = document.getElementById("comments-section");
    
        const replyFormTemplate = document.getElementById("reply-form-template");
    
        const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
        const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/post/${postId}/`);
    
        // Like/Unlike
        likeBtn.addEventListener("click", () => {
            const isLiked = likeBtn.dataset.liked === "true";
            socket.send(JSON.stringify({
                type: "toggle_like",
                username: username,
                is_liked: isLiked
            }));
        });
    
        // Send comment
        sendCommentBtn.addEventListener("click", () => {
            const text = commentInput.value.trim();
            if (text.length > 0) {
                socket.send(JSON.stringify({
                    type: "new_comment",
                    username: username,
                    text: text
                }));
                commentInput.value = "";
            }
        });
    
        // Send reply (delegated listener)
        commentsSection.addEventListener("click", (e) => {
            if (e.target.classList.contains("reply-btn")) {
                const commentId = e.target.dataset.parentId;
                let commentDiv = e.target.closest(".comment");
    
                if (!commentDiv.querySelector(".reply-input")) {
                    const replyForm = replyFormTemplate.cloneNode(true);
                    replyForm.style.display = "block";
                    commentDiv.appendChild(replyForm);
    
                    const replyInput = replyForm.querySelector(".reply-input");
                    const sendReplyBtn = replyForm.querySelector(".send-reply");
    
                    sendReplyBtn.addEventListener("click", () => {
                        const replyText = replyInput.value.trim();
                        if (replyText.length > 0) {
                            socket.send(JSON.stringify({
                                type: "new_reply",
                                username: username,
                                text: replyText,
                                parent_id: commentId
                            }));
                            replyForm.remove();
                        }
                    });
                }
            }
        });
    
        // Handle incoming WebSocket messages
        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
    
            if (data.type === "like_update_broadcast") {
                console.log('like_update_broadcast')
                likeCount.textContent = data.total_likes;
            }
            
            if (data.type === "like_update_personal") {
                console.log('like_update_personal')
                likeBtn.dataset.liked = data.is_liked.toString();
                likeBtn.textContent = data.is_liked ? "‚ù§Ô∏è Unlike" : "ü§ç Like";
            }
    
            else if (data.type === "new_comment") {
                const comment = data.comment;
                const commentHTML = `
                    <div class="comment" data-comment-id="${comment.id}">
                        <p><strong>${comment.username}</strong>: ${comment.text}</p>
                        <button class="reply-btn" data-parent-id="${comment.id}">Reply</button>
                        <div class="replies"></div>
                    </div>
                `;
                commentsSection.insertAdjacentHTML("beforeend", commentHTML);
            }
    
            else if (data.type === "new_reply") {
                const reply = data.reply;
                const parentDiv = commentsSection.querySelector(`[data-comment-id="${reply.parent_id}"] .replies`);
                const replyHTML = `
                    <div class="reply" data-reply-id="${reply.id}">
                        <p><strong>${reply.username}</strong>: ${reply.text}</p>
                    </div>
                `;
                parentDiv.insertAdjacentHTML("beforeend", replyHTML);
            }
        };
    
        socket.onclose = function() {
            console.error("WebSocket closed unexpectedly");
        };
    });
    </script>
    

{% endblock %}
